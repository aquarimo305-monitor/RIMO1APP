<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIMO - pH History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="card shadow p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>pH Level History</h3>
                <span id="tank-badge" class="badge bg-info text-dark">Detecting Tank Type...</span>
            </div>
            <canvas id="phChart" height="100"></canvas>
            <div id="ph-alert-msg" class="mt-3"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="navbar.js"></script>

    <script>
        // 1. Initialize EmailJS with your Public Key
        emailjs.init("TaAvoWcHSyIX4HQ37"); 
        
        const userEmail = localStorage.getItem('rimo_email'); //
        const tankType = localStorage.getItem('rimo_tank_type') || 'freshwater'; //
        
        document.getElementById('tank-badge').innerText = tankType.toUpperCase();

        // 2. Define Safety Limits for Kolkata Setup
        const limits = (tankType === 'saltwater') 
            ? { min: 8.1, max: 8.4 } 
            : { min: 7.0, max: 7.5 };

        // 3. Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBlFo_hv6jsDAJHIRY_6kLe8mPW-0rB8ME",
            authDomain: "rimo-4c770.firebaseapp.com",
            databaseURL: "https://rimo-4c770-default-rtdb.firebaseio.com",
            projectId: "rimo-4c770",
            storageBucket: "rimo-4c770.firebasestorage.app",
            messagingSenderId: "472011782582",
            appId: "1:472011782582:web:3ae7e6b069105c963f2917"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 4. Chart.js Setup
        const ctx = document.getElementById('phChart').getContext('2d');
        const phChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'pH Level',
                    data: [],
                    borderColor: '#0dcaf0',
                    backgroundColor: 'rgba(13, 202, 240, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                scales: {
                    y: { min: 6.0, max: 9.0 }
                }
            }
        });

        // 5. Data Listener & Alert Logic
        let lastEmailSent = 0;

        db.ref('ph_history').limitToLast(15).on('value', (snapshot) => {
            const data = snapshot.val();
            const labels = [];
            const values = [];

            if (data) {
                Object.keys(data).forEach(key => {
                    if (key !== 'init' && data[key].time && data[key].value) {
                        labels.push(data[key].time);
                        values.push(data[key].value);
                    }
                });

                phChart.data.labels = labels;
                phChart.data.datasets[0].data = values;
                phChart.update();

                // Check Latest Value for Alerts
                const latestPh = values[values.length - 1];
                const alertDiv = document.getElementById('ph-alert-msg');

                if (latestPh < limits.min || latestPh > limits.max) {
                    alertDiv.innerHTML = `<div class="alert alert-warning">⚠️ Critical pH: ${latestPh}. Ideal for ${tankType}: ${limits.min}-${limits.max}</div>`;
                    
                    // Send Warning Email (Limit: 1 per hour)
                    const now = Date.now();
                    if (now - lastEmailSent > 3600000 && userEmail) {
                        sendWarning(latestPh);
                        lastEmailSent = now;
                    }
                } else {
                    alertDiv.innerHTML = `<div class="alert alert-success">✅ pH is Stable (${latestPh})</div>`;
                }
            }
        });

        // 6. Complete EmailJS Function matching your Template
        function sendWarning(val) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata' });

            emailjs.send("service_js0niy1", "template_fslbcqb", {
                user_email: userEmail,       //
                tank_type: tankType,       //
                parameter: "pH Level",
                current_value: val,
                time: timeString,
                safe_range: `${limits.min}-${limits.max}`,
                message: `The pH level in your ${tankType} aquarium has drifted to ${val}. High waste levels from goldfish can cause this drop.`
            }, "TaAvoWcHSyIX4HQ37").then(() => console.log("pH Warning Sent Email"));
        }
    </script>
</body>

</html>

