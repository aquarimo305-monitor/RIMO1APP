<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-4 text-center">
        <div class="card shadow p-4 mb-4 bg-primary text-white">
            <h3>Last Feed: <span id="last-feed-time">--:--</span></h3>
            <p>Status: <span id="feed-status">Waiting...</span></p>
        </div>
        
        <div class="card shadow p-4">
            <h5>Feeding History (Last 5 Events)</h5>
            <table class="table mt-3">
                <thead>
                    <tr><th>Time</th><th>Status</th></tr>
                </thead>
                <tbody id="feeder-log">
                    </tbody>
            </table>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="navbar.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBlFo_hv6jsDAJHIRY_6kLe8mPW-0rB8ME",
            authDomain: "rimo-4c770.firebaseapp.com",
            databaseURL: "https://rimo-4c770-default-rtdb.firebaseio.com",
            projectId: "rimo-4c770",
            storageBucket: "rimo-4c770.firebasestorage.app",
            messagingSenderId: "472011782582",
            appId: "1:472011782582:web:3ae7e6b069105c963f2917",
            measurementId: "G-LX260TEY4M"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. Listen for the absolute latest feed status
        db.ref('tank_stats').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data && data.last_feed) {
                document.getElementById('last-feed-time').innerText = data.last_feed;
                document.getElementById('feed-status').innerText = "Confirmed";
            }
        });

        // 2. Build the history table
        db.ref('feeder_history').limitToLast(5).on('value', (snapshot) => {
            const logTable = document.getElementById('feeder-log');
            logTable.innerHTML = "";
            const data = snapshot.val();

            if (data) {
                // Reverse keys to show newest feed at the top
                Object.keys(data).reverse().forEach(key => {
                    const row = `<tr>
                        <td>${data[key].time}</td>
                        <td><span class="badge bg-success">${data[key].status}</span></td>
                    </tr>`;
                    logTable.insertAdjacentHTML('beforeend', row);
                });
            }
        });
    </script>
</body>
</html>